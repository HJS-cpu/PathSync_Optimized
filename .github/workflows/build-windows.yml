name: Build Windows EXE

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v2
    
    - name: Build with MSVC
      shell: cmd
      run: |
        call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars32.bat"
        
        mkdir build
        
        echo === Compiling resources ===
        rc /fo build\pathsync.res PathSync\res.rc
        
        echo === Compiling pathsync.cpp ===
        cl /c /O2 /EHsc /DWIN32 /D_WINDOWS /DNDEBUG /I"WDL" /Fobuild\pathsync.obj PathSync\pathsync.cpp
        
        echo === Compiling fnmatch.cpp ===
        cl /c /O2 /EHsc /DWIN32 /D_WINDOWS /DNDEBUG /I"WDL" /Fobuild\fnmatch.obj PathSync\fnmatch.cpp
        
        echo === Compiling wndsize.cpp ===
        cl /c /O2 /EHsc /DWIN32 /D_WINDOWS /DNDEBUG /I"WDL" /Fobuild\wndsize.obj WDL\WinGUI\wndsize.cpp
        
        echo === Compiling win32_utf8.c ===
        cl /c /O2 /DWIN32 /D_WINDOWS /DNDEBUG /Fobuild\win32_utf8.obj WDL\win32_utf8.c
        
        echo === Linking ===
        link /OUT:build\PathSync.exe /SUBSYSTEM:WINDOWS build\pathsync.obj build\fnmatch.obj build\wndsize.obj build\win32_utf8.obj build\pathsync.res kernel32.lib user32.lib gdi32.lib shell32.lib comctl32.lib comdlg32.lib advapi32.lib ole32.lib
        
        echo === Build complete ===
        dir build\PathSync.exe
    
    - name: Build NSIS Installer
      shell: cmd
      run: |
        echo === Building NSIS Installer ===
        cd PathSync
        makensis ps.nsi
        cd ..
        echo === Installer build complete ===
        dir build\PathSync-*-setup.exe

    - name: Upload portable EXE
      uses: actions/upload-artifact@v4
      with:
        name: PathSync-Portable
        path: build/PathSync.exe
        if-no-files-found: error

    - name: Upload Installer
      uses: actions/upload-artifact@v4
      with:
        name: PathSync-Installer
        path: build/PathSync-*-setup.exe
        if-no-files-found: error
