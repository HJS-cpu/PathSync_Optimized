name: Build Windows EXE

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v2

    - name: Build with MSVC
      shell: cmd
      run: |
        call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars32.bat"

        mkdir build

        echo === Compiling resources ===
        rc /fo build\pathsync.res PathSync\res.rc

        echo === Compiling pathsync.cpp ===
        cl /c /O2 /EHsc /DWIN32 /D_WINDOWS /DNDEBUG /I"WDL" /Fobuild\pathsync.obj PathSync\pathsync.cpp

        echo === Compiling fnmatch.cpp ===
        cl /c /O2 /EHsc /DWIN32 /D_WINDOWS /DNDEBUG /I"WDL" /Fobuild\fnmatch.obj PathSync\fnmatch.cpp

        echo === Compiling wndsize.cpp ===
        cl /c /O2 /EHsc /DWIN32 /D_WINDOWS /DNDEBUG /I"WDL" /Fobuild\wndsize.obj WDL\WinGUI\wndsize.cpp

        echo === Compiling win32_utf8.c ===
        cl /c /O2 /DWIN32 /D_WINDOWS /DNDEBUG /Fobuild\win32_utf8.obj WDL\win32_utf8.c

        echo === Linking ===
        link /OUT:build\PathSync.exe /SUBSYSTEM:WINDOWS build\pathsync.obj build\fnmatch.obj build\wndsize.obj build\win32_utf8.obj build\pathsync.res kernel32.lib user32.lib gdi32.lib shell32.lib comctl32.lib comdlg32.lib advapi32.lib ole32.lib

        echo === Build complete ===
        dir build\PathSync.exe

    - name: Install NSIS
      run: choco install nsis -y
      shell: cmd

    - name: Build NSIS Installer
      shell: cmd
      run: |
        echo === Building NSIS Installer ===
        cd PathSync
        "%ProgramFiles(x86)%\NSIS\makensis.exe" ps.nsi
        cd ..
        echo === Installer build complete ===
        dir build\PathSync-*-setup.exe

    - name: Prepare portable package
      shell: cmd
      run: |
        copy readme.txt build\readme.txt
        copy license.txt build\license.txt

    - name: Upload portable EXE
      uses: actions/upload-artifact@v4
      with:
        name: PathSync-Portable
        path: |
          build/PathSync.exe
          build/readme.txt
          build/license.txt
        if-no-files-found: error

    - name: Upload Installer
      uses: actions/upload-artifact@v4
      with:
        name: PathSync-Installer
        path: build/PathSync-*-setup.exe
        if-no-files-found: error

  release:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Download portable artifact
      uses: actions/download-artifact@v4
      with:
        name: PathSync-Portable
        path: portable

    - name: Download installer artifact
      uses: actions/download-artifact@v4
      with:
        name: PathSync-Installer
        path: installer

    - name: Create portable ZIP
      run: |
        cd portable
        zip -r ../PathSync-Portable.zip .
        cd ..

    - name: Prepare release assets
      run: |
        cp installer/PathSync-*-setup.exe .
        ls -la *.zip *.exe

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        draft: false
        generate_release_notes: false
        files: |
          PathSync-Portable.zip
          PathSync-*-setup.exe
